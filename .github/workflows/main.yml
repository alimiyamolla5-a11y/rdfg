name: Ultra Clean RDP - Sazzad Islam

on:
  workflow_dispatch:
    inputs:
      ts_tailnet:         { description: "Tailscale tailnet (e.g. you@gmail.com)", required: true }
      ts_api_key:         { description: "Tailscale API key", required: true }
      ts_authkey:         { description: "Tailscale Auth key", required: true }
      runtime_minutes:    { description: "Runtime minutes", required: false, default: "355" }

permissions:
  contents: read

defaults:
  run:
    shell: pwsh

jobs:
  clean-rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      - name: Generate Strong Random Password
        id: passgen
        run: |
          $chars = @()
          $chars += [char[]]'abcdefghijklmnopqrstuvwxyz'
          $chars += [char[]]'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 
          $chars += [char[]]'0123456789'
          $chars += [char[]]'!@#$%^&*'
          
          $password = -join ((1..12) | ForEach-Object { 
              $chars | Get-Random 
          })
          "RANDOM_PASS=$password" | Out-File -Append $env:GITHUB_OUTPUT
          Write-Host "Generated password: $password"

      - name: Set Custom User Credentials
        run: |
          $user = "Sazzad Islam"
          $pass = "${{ steps.passgen.outputs.RANDOM_PASS }}"
          
          # Create or update user
          $secpass = ConvertTo-SecureString $pass -AsPlainText -Force
          
          # Remove if exists and create fresh
          Remove-LocalUser -Name $user -ErrorAction SilentlyContinue
          New-LocalUser -Name $user -Password $secpass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $user
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user
          
          "RDP_USER=$user" | Out-File -Append $env:GITHUB_ENV
          "RDP_PASS=$pass" | Out-File -Append $env:GITHUB_ENV
          Write-Host "User created: $user"

      - name: Install Only Tailscale (Essential)
        run: |
          $ts = "$env:ProgramFiles\Tailscale\tailscale.exe"
          if (-not (Test-Path $ts)) {
            $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
            $dst = "$env:TEMP\tailscale.msi"
            Invoke-WebRequest -Uri $url -OutFile $dst
            Start-Process msiexec.exe -ArgumentList "/i","`"$dst`"","/quiet","/norestart" -Wait
            Remove-Item $dst -Force
          }
          & $ts up --authkey "${{ inputs.ts_authkey }}" --hostname "sazzadx21" --accept-dns=false --accept-routes=false --advertise-exit-node=false --shields-up=false
          $ip4 = & $ts ip -4
          "TAILSCALE_IP=$ip4" | Out-File -Append $env:GITHUB_ENV
          Write-Host "Tailscale IP: $ip4"

      - name: Ultra Fast RDP Setup
        run: |
          # Enable RDP
          Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" | Out-Null
          
          # Extreme Performance Optimizations
          $rdpPath = "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp"
          Set-ItemProperty -Path $rdpPath -Name "MinEncryptionLevel" -Value 1 -Type DWord -Force
          Set-ItemProperty -Path $rdpPath -Name "SecurityLayer" -Value 0 -Type DWord -Force
          Set-ItemProperty -Path $rdpPath -Name "UserAuthentication" -Value 0 -Type DWord -Force
          Set-ItemProperty -Path $rdpPath -Name "MaxXResolution" -Value 1280 -Type DWord -Force
          Set-ItemProperty -Path $rdpPath -Name "MaxYResolution" -Value 720 -Type DWord -Force
          Set-ItemProperty -Path $rdpPath -Name "ColorDepth" -Value 3 -Type DWord -Force
          
          # Network Optimizations
          netsh int tcp set global autotuninglevel=normal | Out-Null
          netsh int tcp set global rss=enabled | Out-Null
          
          # TCPNoDelay registry setting with proper path
          $tcpPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services"
          if (-not (Test-Path $tcpPath)) {
              New-Item -Path $tcpPath -Force | Out-Null
          }
          New-ItemProperty -Path $tcpPath -Name "TCPNoDelay" -Value 1 -PropertyType DWord -Force | Out-Null
          
          # Disable Visual Effects
          Set-ItemProperty "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" -Name "VisualFXSetting" -Value 2 -Type DWord -Force
          
          Write-Host "üöÄ Ultra Fast RDP Ready!"

      - name: Disable Unnecessary Services
        run: |
          # Stop and disable non-essential services (safe ones only)
          $services = @(
              "Themes",
              "WSearch",
              "TabletInputService", 
              "WpnService"
          )
          
          foreach ($service in $services) {
              try {
                  $svc = Get-Service -Name $service -ErrorAction SilentlyContinue
                  if ($svc) {
                      Stop-Service -Name $service -Force -ErrorAction SilentlyContinue
                      Set-Service -Name $service -StartupType Disabled -ErrorAction SilentlyContinue
                      Write-Host "‚úÖ Disabled: $service"
                  }
              } catch {
                  Write-Host "‚ö†Ô∏è Could not disable: $service"
              }
          }

      - name: Clean Temporary Files
        run: |
          # Clean temp files to save space
          Get-ChildItem -Path "$env:TEMP\*" -Recurse -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "‚úÖ Temp files cleaned"

      - name: Show Connection Info
        run: |
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "üöÄ YOUR ULTRA CLEAN RDP IS READY!"
          Write-Host "=========================================="
          Write-Host "üë§ Username: Sazzad Islam"
          Write-Host "üîê Password: $env:RDP_PASS" 
          Write-Host "üîó Tailscale IP: $env:TAILSCALE_IP"
          Write-Host "üè∑Ô∏è Hostname: sazzadx21"
          Write-Host "=========================================="
          Write-Host "üìù Connect using Microsoft Remote Desktop"
          Write-Host "üìç Address: $env:TAILSCALE_IP"
          Write-Host "üë§ Username: Sazzad Islam" 
          Write-Host "üîê Password: $env:RDP_PASS"
          Write-Host "‚è∞ Runtime: ${{ inputs.runtime_minutes }} minutes"
          Write-Host "=========================================="
          Write-Host ""

      - name: Keep Alive
        run: |
          $mins = [int]"${{ inputs.runtime_minutes }}"
          if ($mins -lt 1) { $mins = 355 }
          if ($mins -gt 360) { $mins = 355 }
          
          $end = (Get-Date).AddMinutes($mins)
          Write-Host "RDP Session Started - Ends at: $($end.ToString('HH:mm:ss'))"
          Write-Host ""
          
          while ((Get-Date) -lt $end) {
              $remaining = ($end - (Get-Date)).ToString("hh\:mm\:ss")
              Write-Host "üü¢ Active - Time remaining: $remaining - User: Sazzad Islam - IP: $env:TAILSCALE_IP"
              Start-Sleep -Seconds 60
          }
          
          Write-Host "Session completed successfully! ‚úÖ"
