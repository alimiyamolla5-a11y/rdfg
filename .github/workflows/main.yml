name: Next-Level Tailscale RDP - Random Password

on:
  workflow_dispatch:
    inputs:
      ts_authkey:       { description: "Tailscale Auth Key", required: true }
      runtime_minutes:  { description: "RDP Runtime (minutes)", required: false, default: "360" }

jobs:
  tailscale-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:

    # ---------------------------
    # 1Ô∏è‚É£ Generate Random Password
    # ---------------------------
    - name: Generate Random Password
      id: passwordgen
      run: |
        $chars = @()
        $chars += [char[]]'ABCDEFGHIJKLMNOPQRSTUVWXYZ'
        $chars += [char[]]'abcdefghijklmnopqrstuvwxyz'
        $chars += [char[]]'0123456789'
        $chars += [char[]]'!@#$%^&*'
        $pwd = -join ((1..12) | ForEach-Object { $chars | Get-Random })
        echo "RDP_PASS=$pwd" >> $env:GITHUB_ENV
        Write-Host "Generated RDP password: $pwd"

    # ---------------------------
    # 2Ô∏è‚É£ Create RDP User
    # ---------------------------
    - name: Create RDP User
      run: |
        $user = "sazzadx21"
        $secure = ConvertTo-SecureString $env:RDP_PASS -AsPlainText -Force

        Remove-LocalUser -Name $user -ErrorAction SilentlyContinue
        New-LocalUser -Name $user -Password $secure -FullName "Sazzad Islam" -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member $user
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user

        echo "RDP_USER=$user" >> $env:GITHUB_ENV
        Write-Host "‚úÖ RDP User created: $user"

    # ---------------------------
    # 3Ô∏è‚É£ Enable RDP + Firewall
    # ---------------------------
    - name: Enable RDP
      run: |
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name UserAuthentication -Value 0
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name SecurityLayer -Value 1
        Set-ItemProperty 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name MinEncryptionLevel -Value 1

    # ---------------------------
    # 4Ô∏è‚É£ Install Tailscale
    # ---------------------------
    - name: Install Tailscale
      run: |
        $tsPath = "$env:ProgramFiles\Tailscale\tailscale.exe"
        if (-not (Test-Path $tsPath)) {
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $dst = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $url -OutFile $dst
          Start-Process msiexec.exe -ArgumentList "/i","`"$dst`"","/quiet","/norestart" -Wait
          Remove-Item $dst -Force
        }

    # ---------------------------
    # 5Ô∏è‚É£ Connect Tailscale
    # ---------------------------
    - name: Connect Tailscale
      run: |
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey="${{ inputs.ts_authkey }}" --hostname="ts-$([guid]::NewGuid().ToString('N').Substring(0,6))"
        $tsIP = $null
        $retries = 0
        while (-not $tsIP -and $retries -lt 15) {
          $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          Start-Sleep -Seconds 5
          $retries++
        }
        if (-not $tsIP) { Write-Error "Tailscale IP not assigned. Exiting."; exit 1 }
        echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
        Write-Host "‚úÖ Tailscale IP: $tsIP"

    # ---------------------------
    # 6Ô∏è‚É£ Ultra Gaming + Clean Mode
    # ---------------------------
    - name: Gaming & Clean Optimizations
      run: |
        powercfg -setactive SCHEME_MIN
        powercfg /change monitor-timeout-ac 0
        powercfg /hibernate off

        netsh int tcp set global autotuninglevel=high
        netsh int tcp set global rss=enabled
        reg add "HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\Interfaces" /v TCPNoDelay /t REG_DWORD /d 1 /f
        reg add "HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\Interfaces" /v TcpAckFrequency /t REG_DWORD /d 1 /f

        # RAM, Visual, Audio Tweaks
        reg add "HKLM\SYSTEM\ControlSet001\Control\Session Manager\Memory Management" /v DisablePagingExecutive /t REG_DWORD /d 1 /f
        reg add "HKLM\SYSTEM\ControlSet001\Control\Session Manager\Memory Management" /v LargeSystemCache /t REG_DWORD /d 1 /f
        reg add "HKCU\Control Panel\Mouse" /v MouseSensitivity /t REG_SZ /d 10 /f
        reg add "HKLM\SOFTWARE\Microsoft\Windows\Dwm" /v EnableAeroPeek /t REG_DWORD /d 0 /f
        reg add "HKCU\Control Panel\Desktop" /v Wallpaper /t REG_SZ /d "" /f
        RUNDLL32.EXE user32.dll,UpdatePerUserSystemParameters
        reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" /v VisualFXSetting /t REG_DWORD /d 2 /f
        reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\MMDevices\Audio\Render" /v LowLatencyMode /t REG_DWORD /d 1 /f
        reg add "HKCU\Software\Microsoft\Multimedia\Audio" /v UserDuckingPreference /t REG_DWORD /d 3 /f

    # ---------------------------
    # 7Ô∏è‚É£ Show RDP Info
    # ---------------------------
    - name: Show RDP Info
      run: |
        $data = Invoke-WebRequest -UseBasicParsing http://127.0.0.1:4040/api/tunnels
        $json = $data.Content | ConvertFrom-Json
        $addr = $json.tunnels.public_url

        Write-Host "======================================="
        Write-Host "üî• NEXT-LEVEL NGROK RDP READY!"
        Write-Host "‚ñ∂ Connect To: $addr"
        Write-Host "üë§ User: $env:RDP_USER"
        Write-Host "üîê Password: $env:RDP_PASS"
        Write-Host "======================================="

    # ---------------------------
    # 8Ô∏è‚É£ Keep Alive
    # ---------------------------
    - name: Keep Alive
      run: |
        while ($true) {
          Write-Host "üü¢ RDP Active - Waiting..."
          Start-Sleep -Seconds 60
        }
